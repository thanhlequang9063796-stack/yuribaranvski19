format_version: '11'
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
  - PROJECT_PATH: "Guru Barbecue.xcworkspace"   # или OakLedger.xcodeproj
  - SCHEME: "Guru Barbecue"
  - BUNDLE_ID: "com.baranovua.ybsignature"
  - EXPORT_METHOD: "app-store"              # для TestFlight
  # Опционально:
  # - MARKETING_VERSION: "1.1"
  # - BUILD_NUMBER: ""                       # если пусто — возьмём timestamp

workflows:
  ios_testflight:
    meta:
      bitrise.io:
        stack: osx-xcode-15.4.x
    steps:
    - git-clone@8: {}
    - cache-pull@2: {}

    # Ставит .p12 и .mobileprovision из Code Signing
    - certificate-and-profile-installer@1: {}

    # (опционально) обновим номер билда и/или маркетинговую версию
    - set-xcode-project-build-number@1:
        inputs:
        - build_number: "$BUILD_NUMBER"
        - build_version_offset: "0"
        - use_timestamp: "yes"              # если BUILD_NUMBER не задан
    # - set-xcode-project-version@1:
    #     inputs:
    #     - version: "$MARKETING_VERSION"

    # Архивируем и экспортируем IPA
    - xcode-archive@5:
        inputs:
        - project_path: "$PROJECT_PATH"
        - scheme: "$SCHEME"
        - configuration: "Release"
        - distribution_method: "$EXPORT_METHOD"   # app-store
        - automatic_code_signing: "off"           # ручной сайнинг, профили уже установлены
        - compile_bitcode: "no"
        - team_id: ""                             # можно оставить пустым — возьмётся из профиля
        # Если нужно строго зафиксировать профиль:
        # - export_options_plist_content: |-
        #     <?xml version="1.0" encoding="UTF-8"?>
        #     <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        #     <plist version="1.0"><dict>
        #       <key>method</key><string>app-store</string>
        #       <key>signingStyle</key><string>manual</string>
        #       <key>provisioningProfiles</key><dict>
        #         <key>com.onalpocan.oakledger.ios</key><string>YOUR_PROFILE_NAME_OR_UUID</string>
        #       </dict>
        #     </dict></plist>

    - deploy-to-bitrise-io@2: {}   # артефакты (ipa, dSYM, xcarchive)

    # Загрузка в App Store Connect и публикация в TestFlight
    - app-store-connect-upload@1:
        inputs:
        - issuer_id: "$APP_STORE_CONNECT_ISSUER_ID"       # Secrets
        - key_id: "$APP_STORE_CONNECT_KEY_IDENTIFIER"
        - private_key: "$APP_STORE_CONNECT_PRIVATE_KEY"   # само содержание ключа (.p8)
        - submit_to_testflight: "yes"
        - skip_wait_for_build_processing: "yes"
        - verbose_log: "yes"

    - cache-push@2: {}
