format_version: "11"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git

app:
  envs:
    - PROJECT_PATH: "Guru Barbecue.xcodeproj"
    - SCHEME: "Guru Barbecue"
    - EXPORT_METHOD: "app-store"
    - TEAM_ID: "436YU6KQQ2"
    - BUNDLE_ID: "com.baranovua.ybsignature"
    # Имя профиля как в Bitrise/Xcode (если не уверен — подставь UUID)
    - PROFILE_SPECIFIER: "YB Signature Grill No Results"

workflows:
  deliver_testflight:
    meta:
      bitrise.io:
        stack: osx-xcode-16.4.x
    steps:
      - git-clone@8: {}
      - certificate-and-profile-installer@1: {}

      - xcode-archive@5:
          inputs:
            - project_path: "$PROJECT_PATH"
            - scheme: "$SCHEME"
            - configuration: "Release"
            - distribution_method: "$EXPORT_METHOD"          # app-store
            - automatic_code_signing: "off"                  # ручной сайнинг
            - compile_bitcode: "false"
            - upload_bitcode: "false"
            # Жёстко задаём сайнинг: команда одной строкой
            - xcodebuild_options: >-
                -destination 'generic/platform=iOS'
                DEVELOPMENT_TEAM=$TEAM_ID
                CODE_SIGN_STYLE=Manual
                CODE_SIGN_IDENTITY="Apple Distribution"
                PROVISIONING_PROFILE_SPECIFIER="$PROFILE_SPECIFIER"
            # На случай нескольких таргетов/рассинхрона — дублируем через exportOptions
            - export_options_plist_content: |-
                <?xml version="1.0" encoding="UTF-8"?>
                <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
                <plist version="1.0">
                <dict>
                  <key>method</key><string>app-store</string>
                  <key>teamID</key><string>${TEAM_ID}</string>
                  <key>signingStyle</key><string>manual</string>
                  <key>provisioningProfiles</key>
                  <dict>
                    <key>${BUNDLE_ID}</key><string>${PROFILE_SPECIFIER}</string>
                  </dict>
                  <key>stripSwiftSymbols</key><true/>
                  <key>destination</key><string>export</string>
                </dict>
                </plist>

      - app-store-connect-upload@1:
          inputs:
            - issuer_id: "$APP_STORE_CONNECT_ISSUER_ID"
            - key_id: "$APP_STORE_CONNECT_KEY_IDENTIFIER"
            - private_key: "$APP_STORE_CONNECT_PRIVATE_KEY"
            - submit_to_testflight: "yes"
            - skip_wait_for_build_processing: "yes"
            - verbose_log: "yes"

      - deploy-to-bitrise-io@2: {}
