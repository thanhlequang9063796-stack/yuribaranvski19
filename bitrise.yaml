workflows:
  archive_and_export_app:
    steps:
      - git-clone@8: {}
      - certificate-and-profile-installer@1: {}
      - xcode-archive@5:
          inputs:
            - project_path: "Guru Barbecue.xcodeproj"
            - scheme: "Guru Barbecue"
            - distribution_method: "app-store"
            - automatic_code_signing: "off"
            - compile_bitcode: "false"
            - upload_bitcode: "false"
            - xcodebuild_options: >-
                -destination 'generic/platform=iOS'
                DEVELOPMENT_TEAM=436YU6KQQ2
                CODE_SIGN_STYLE=Manual
                CODE_SIGN_IDENTITY="Apple Distribution"
                PROVISIONING_PROFILE_SPECIFIER="7e8a0c24-f6b3-48fd-bbc8-f109dd20ef13"

      # ⬇️ создаём файл ключа и экспортим путь в env
      - script@1:
          title: "Write ASC API key to file"
          inputs:
            - content: |-
                set -euo pipefail
                : "${APP_STORE_CONNECT_PRIVATE_KEY:?Missing APP_STORE_CONNECT_PRIVATE_KEY}"
                : "${APP_STORE_CONNECT_KEY_IDENTIFIER:?Missing APP_STORE_CONNECT_KEY_IDENTIFIER}"
                : "${APP_STORE_CONNECT_ISSUER_ID:?Missing APP_STORE_CONNECT_ISSUER_ID}"

                mkdir -p "$BITRISE_SOURCE_DIR/.asc"
                KEY_PATH="$BITRISE_SOURCE_DIR/.asc/asc_api_key.p8"
                printf "%s\n" "$APP_STORE_CONNECT_PRIVATE_KEY" > "$KEY_PATH"
                # на всякий случай проверим, что в файле есть заголовки
                grep -q "BEGIN PRIVATE KEY" "$KEY_PATH" || { echo "❌ BAD .p8 content"; exit 1; }

                echo "ASC_API_KEY_PATH=$KEY_PATH" >> "$BITRISE_ENV_FILE"
                echo "✅ Wrote API key to $KEY_PATH"

      # ⬇️ грузим через deliver, указывая api_key_path
      - deploy-to-itunesconnect-deliver@2:
          inputs:
            - connection: "off"                      # форсим off, чтобы брать из inputs
            - ipa_path: "$BITRISE_IPA_PATH"
            - platform: "ios"
            - app_identifier: "com.baranovua.ybsignature"
            # авторизация по API-ключу из файла
            - api_key_path: "$ASC_API_KEY_PATH"
            - api_issuer: "$APP_STORE_CONNECT_ISSUER_ID"
            - api_key_id: "$APP_STORE_CONNECT_KEY_IDENTIFIER"
            # дополнительные флаги
            - skip_metadata: "yes"
            - skip_screenshots: "yes"
            - submit_beta_app_review: "yes"
            - skip_waiting_for_build_processing: "yes"

      - deploy-to-bitrise-io@2: {}
